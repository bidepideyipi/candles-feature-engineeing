```text
原始版本
[
    # 1-Hour Base Features (CORE PREDICTIVE FEATURES)
    close_1h_normalized,     # Normalized price (NOT raw timestamp)
    volume_1h_normalized,    # Normalized volume
    rsi_7_1h,                # Ultra-fast momentum (very sensitive)
    rsi_14_1h,               # Fast momentum (standard short-term)
    rsi_28_1h,               # Slow momentum (longer-term trend)
    macd_line_1h, macd_signal_1h, macd_histogram_1h,  # Trend following（12,26,9）
    
    # Time Context (CYCLICAL ENCODING)
    hour_cos, hour_sin,      # Cyclical time features (REPLACES raw timestamp)
    day_of_week,             # Weekly seasonality
    
    # 15-Minute High-Frequency Features
    rsi_7_15m,               # Immediate momentum reactions
    rsi_14_15m,               # Quick moves detection  
    rsi_28_15m,              # Short-term momentum
    macd_line_15m, macd_signal_15m, macd_histogram_15m,  # Trend following（12,26,9）
    volume_impulse_15m,      # Recent volume spikes（15分钟级别的成交量脉冲/激增指标）
    
    # 4-Hour Medium-Term Features  
    rsi_7_4h,               # Medium-term sensitivity
    rsi_14_4h,              # Standard medium-term
    rsi_28_4h,              # Longer medium-term trend
    macd_line_4h, macd_signal_4h, macd_histogram_4h,  # Trend following（12,26,9）
    trend_continuation_4h,  # Trend strength metric（趋势延续强度）
    
    # 1-Day Long-Term Context
    rsi_7_1d,              # Daily momentum
    rsi_14_1d,              # Multi-day trend
    rsi_28_1d,              # Extended trend analysis
    macd_line_1d, macd_signal_1d, macd_histogram_1d,  # Trend following（12,26,9）
    atr_1d,                 # Average True Range (volatility) 平均真实波幅
    support_distance_1d, resistance_distance_1d,  # Key levels
    
    # Cross-Timeframe Intelligence
    tf_momentum_confirmation,  # Do all timeframes agree?
    inter_tf_divergence,       # Contradictory signals across TFs
    multi_timeframe_score,     # Weighted trend consensus
    volatility_regime_1d,      # High/Low volatility state
    
    # Predictive Enhancements
    price_acceleration_1h,     # Rate of change
    volume_profile_1h,         # Volume distribution
    order_flow_imbalance,      # Buy/sell pressure
]
```

# MVP Feature Set (Minimum Viable Product)
### 1-Hour Base Layer (核心基础特征)
close_1h_normalized,    # 价格标准化
volume_1h_normalized,   # 成交量标准化
rsi_14_1h,              # 标准短期动量指标
macd_line_1h, macd_signal_1h,  # 趋势跟踪

### 时间编码 (替代时间戳)
hour_cos, hour_sin,     # 周期性时间特征
day_of_week,            # 周期性特征

### 15分钟高频特征 (短期信号)
rsi_14_15m,             # 快速动量反应
volume_impulse_15m,     # 成交量脉冲 (推荐20周期窗口)

### 4小时中期特征 (趋势确认)
rsi_14_4h,              # 中期动量
trend_continuation_4h,  # 趋势延续强度

```Text
    完成度100%，训练样本数1464；
    ============================================================
    训练结果摘要
    ============================================================
    准确率: 0.7031
    交叉验证准确率: 0.7148 (+/- 0.0510)
    训练时间: 2026-02-03T20:25:45.710812
    各类别置信度:
    类别 1: 0.7688
    类别 2: 0.6771
    类别 3: 0.5398
    类别 4: 0.5131
    类别 5: 0.5324
    类别 6: 0.6001
    类别 7: 0.8669
    ============================================================
```


# Version 1.0 Feature Set
### 1-Hour Base Layer (核心基础特征)
close_1h_normalized,    # 价格标准化
volume_1h_normalized,   # 成交量标准化
rsi_14_1h,              # 标准短期动量指标
macd_line_1h, macd_signal_1h,  # 趋势跟踪

### 时间编码 (替代时间戳)
hour_cos, hour_sin,     # 周期性时间特征
day_of_week,            # 周期性特征

### 15分钟高频特征 (短期信号)
rsi_14_15m,             # 快速动量反应
volume_impulse_15m,     # 成交量脉冲 (推荐20周期窗口)
macd_line_15m, macd_signal_15m,  # 趋势跟踪
atr_15m                 # 短期波动率（新增）
stoch_k_15m, stoch_d_15m  # 短期超买超卖（新增）

### 4小时中期特征 (趋势确认)
rsi_14_4h,              # 中期动量
trend_continuation_4h,  # 趋势延续强度
macd_line_4h, macd_signal_4h,  # 趋势跟踪
atr_4h                  # 4小时波动率（新增）
adx_4h, plus_di_4h, minus_di_4h  # 4小时趋势强度（新增）
ema_12_4h, ema_26_4h, ema_48_4h  # 4小时均线（新增）

### 1D框架（新增）
rsi_14_1d       # 日线动量
atr_1d          # 日线波动率

---

## Version 1.0 特征统计

### 特征分布
| 时间框架 | 特征数 | 特征列表 |
|---------|--------|---------|
| 1小时基础层 | 5 | close_1h_normalized, volume_1h_normalized, rsi_14_1h, macd_line_1h, macd_signal_1h |
| 时间编码 | 3 | hour_cos, hour_sin, day_of_week |
| 15分钟高频 | 7 | rsi_14_15m, volume_impulse_15m, macd_line_15m, macd_signal_15m, atr_15m, stoch_k_15m, stoch_d_15m |
| 4小时中期 | 10 | rsi_14_4h, trend_continuation_4h, macd_line_4h, macd_signal_4h, atr_4h, adx_4h, plus_di_4h, minus_di_4h, ema_12_4h, ema_26_4h, ema_48_4h |
| 1日线框架 | 2 | rsi_14_1d, atr_1d |

**总计：27 个特征**

### 新增特征对比 (从 MVP 到 Version 1.0)
| 类别 | MVP | Version 1.0 | 新增 |
|------|-----|-------------|------|
| 15分钟 | 2 | 7 | +5 (MACD, ATR, Stochastic) |
| 4小时 | 2 | 10 | +8 (MACD, ATR, ADX, +DI/-DI, 3 EMA) |
| 1日线 | 0 | 2 | +2 (RSI, ATR) |
| **总计** | **16** | **27** | **+11** |

### 新增技术指标说明

| 指标 | 计算器文件 | 用途 |
|------|-----------|------|
| ATR | atr_calculator.py | 波动率测量 |
| Stochastic | stoch_calculator.py | 超买超卖信号 |
| ADX | adx_calculator.py | 趋势强度 |
| +DI/-DI | adx_calculator.py (组合) | 趋势方向 |
| EMA | ema_calculator.py | 指数移动平均 |

```Text
    完成度100%，训练样本数12119；
    标签分布:
    1    1327
    2    2190
    3    1920
    4    1122
    5    1960
    6    2180
    7    1420
    ============================================================
    训练结果摘要
    ============================================================
    准确率: 0.6180
    交叉验证准确率: 0.5991 (+/- 0.0180)
    训练时间: 2026-02-04T20:16:28.554592
    各类别置信度:
    类别 1: 0.5452
    类别 2: 0.3603
    类别 3: 0.2946
    类别 4: 0.2606
    类别 5: 0.2822
    类别 6: 0.3772
    类别 7: 0.5827
    ============================================================
    参数调优建议:
    ============================================================
    ⚠️ 模型准确率较低
    建议: 检查特征质量，考虑增加更多特征

    最重要的 5 个特征:
    1. f27
    2. f7
    3. f26
    4. f25
    5. f24

    调整
    CLASSIFICATION_THRESHOLDS = {   
        1: (-100, -1.2),    
        2: (-1.2, 1.2),     
        3: (1.2, 100),       
    }
    后标签分布:
    1    3927
    2    4147
    3    4045
    ============================================================
    训练结果摘要
    ============================================================
    准确率: 0.8218
    交叉验证准确率: 0.8015 (+/- 0.0206)
    训练时间: 2026-02-04T21:14:14.350351
    各类别平均置信度:
    类别 1: 0.6379
    类别 2: 0.5431
    类别 3: 0.6489

    排名 7 类特征               3 类特征            变化 
    1   f27 (atr_1d)        f7 (day_of_week)    ↗ 上升 
    2   f7 (day_of_week)    f25 (ema_48_4h)     ↗ 上升 
    3   f26 (rsi_1d)        f26 (rsi_1d)        - 不变 
    4   f25 (ema_48_4h)     f27 (atr_1d)        ↘ 下降 
    5   f24 (ema_26_4h)     f24 (ema_26_4h)     - 不变
}
```
### 调整 XGBoost 参数
```json
params = {
    'objective': 'multi:softprob',
    'num_class': 3,
    'max_depth': 8,                    # 增加深度捕捉更复杂模式
    'learning_rate': 0.05,             # 降低学习率，增加迭代次数
    'subsample': 0.8,
    'colsample_bytree': 0.8,
    'random_state': 42,
    'eval_metric': 'mlogloss',
    'min_child_weight': 3,             # 防止过拟合
    'gamma': 0.1,                      # 最小分裂增益
    'reg_alpha': 0.1,                  # L1 正则化
    'reg_lambda': 1                    # L2 正则化
}
```

### 同时增加迭代次数
```json
self.model = xgb.train(
    params,
    dtrain,
    num_boost_round=300,              # 从 100 增加到 300
    evals=[(dtrain, 'train'), (dtest, 'test')],
    early_stopping_rounds=20,          # 从 10 增加到 20
    verbose_eval=False
)
```
```text
训练样本数13266；
标签分布:
1    4250
2    4706
3    4310
============================================================
训练结果摘要
============================================================
准确率: 0.8504
交叉验证准确率: 0.8206 (+/- 0.0205)
训练时间: 2026-02-05T13:54:39.225485
各类别置信度:
  类别 1: 0.7545
  类别 2: 0.6418
  类别 3: 0.7595

```
#### 在 feature_1D_creator.py 中新增
- bollinger_upper_1d  # 布林带上轨
- bollinger_lower_1d  # 布林带下轨
- bollinger_position_1d  # 布林带位置（价格在带内的相对位置）
####  在 feature_4h_creator.py 中新增
- ema_cross_4h_12_26  # EMA 交叉信号（12 vs 26, 26 vs 48）
- ema_cross_4h_26_48  # EMA 交叉信号（26 vs 48）
```text
============================================================
训练结果摘要
============================================================
准确率: 0.8497
交叉验证准确率: 0.8281 (+/- 0.0169)
训练时间: 2026-02-05T19:03:09.847009
各类别置信度:
  类别 1: 0.7896
  类别 2: 0.6610
  类别 3: 0.7834

feature  importance
35     f35    4.510117  bollinger_lower_1d
8       f8    3.780634  day_of_week
31     f31    3.459179  ema_cross_4h_12_26
34     f34    3.364948  ema_cross_4h_26_48
19     f19    3.337129  rsi_14_1d
28     f28    3.232294  atr_1d
20     f20    3.151993  rsi_14_4h
32     f32    3.136538  ema_26_4h
```

##feature_1.01.pinbar

### 新增：K 线形态特征（1H）- 优化版

基于 1H 最近一根蜡烛的上下引线比例，用于识别市场情绪和力量对比：

### 优化说明

**初始设计（12 个特征）**：
- 绝对值特征（3 个）：upper_shadow_1h, lower_shadow_1h, body_height_1h
- 比例特征（5 个）：upper_shadow_ratio_1h, lower_shadow_ratio_1h, total_shadow_ratio_1h, shadow_imbalance_1h, body_ratio_1h
- 分类特征（4 个）：is_long_upper_shadow_1h, is_long_lower_shadow_1h, is_doji_1h, shadow_type_1h

**优化后（5 个特征）**：
- 删除原因：绝对值特征太小（约 5 美元），与其他特征（RSI 0-100）不在同一量级
- 删除原因：分类特征（0/1 或 0-3）不适合 XGBoost，优先使用连续特征
- 保留特征：比例特征（无量纲，0-1 范围）与其他特征量纲一致

### 最终特征（5 个）

| 特征名 | 说明 | 类型 | 预期作用 |
|--------|------|------|---------|
| upper_shadow_ratio_1h | 上引线比例 | 浮点（0-1） | 标准化后的上影线强度，识别抛压 |
| lower_shadow_ratio_1h | 下引线比例 | 浮点（0-1） | 标准化后的下影线强度，识别支撑 |
| total_shadow_ratio_1h | 总影线比例 | 浮点（0-1） | 反映市场不确定性，比例高表示多空分歧大 |
| shadow_imbalance_1h | 影线不平衡度 | 浮点（-1 到 1） | 正值=下影线更长（多头），负值=上影线更长（空头） |
| body_ratio_1h | 实体占比 | 浮点（0-1） | 反映趋势强度，大实体表示趋势确认 |

### 特征计算

```python
# 上引线（Upper Shadow/Wick）
upper_shadow_1h = high - max(open, close)

# 下引线（Lower Shadow/Wick）
lower_shadow_1h = min(open, close) - low

# 实体高度（Body Height）
body_height_1h = abs(close - open)

# 上引线比例（相对于实体）
upper_shadow_ratio_1h = upper_shadow_1h / body_height_1h if body_height_1h > 0 else 0

# 下引线比例（相对于实体）
lower_shadow_ratio_1h = lower_shadow_1h / body_height_1h if body_height_1h > 0 else 0

# 总影线比例（相对于 K 线范围）
total_shadow_ratio_1h = (upper_shadow_1h + lower_shadow_1h) / (high - low)

# 影线不平衡度（上引线 - 下引线，相对于 K 线范围）
shadow_imbalance_1h = (upper_shadow_1h - lower_shadow_1h) / (high - low)

# 实体占 K 线比例
body_ratio_1h = body_height_1h / (high - low)
```

### 特征设计理由

1. **只保留比例特征**：无量纲，与其他特征（RSI, MACD）量纲一致
2. **删除绝对值特征**：避免量纲不一致导致模型误判
3. **删除分类特征**：XGBoost 更适合连续特征
4. **影线不平衡度**：量化多空力量对比，正值=多头，负值=空头
5. **实体比例**：反映趋势强度，大实体=趋势确认

### 预期效果

- **shadow_imbalance_1h < -0.5** + **body_ratio_1h < 0.3** = 空头主导（潜在下跌）
- **shadow_imbalance_1h > 0.5** + **body_ratio_1h < 0.3** = 多头主导（潜在上涨）
- **total_shadow_ratio_1h > 0.7** + **body_ratio_1h < 0.2** = 市场犹豫（十字星）
- **body_ratio_1h > 0.7** + **shadow_imbalance_1h ≈ 0** = 趋势确认

### 实现位置

这些特征已添加到：
- `src/feature/feature_1h_creator.py`
- `src/feature/feature_merge.py`

### 特征统计

| 类别 | 特征数 | 变化 |
|------|--------|------|
| 1H | 13 | +5 (Pinbar 比例） |
| 15m | 8 | 0 |
| 4H | 14 | 0 |
| 1D | 5 | 0 |
| **总计** | **40** | **+5** |

### 优化结果

```
优化前：48 个特征
- 包含 12 个 Pinbar 特征
- Pinbar 特征重要性极低（0.5 - 1.5）

优化后：40 个特征
- 包含 5 个 Pinbar 比例特征
- 提升特征质量，量纲一致
```

============================================================
训练结果摘要
============================================================
训练集数量：13484 条记录
准确率: 0.7653
交叉验证准确率: 0.7127 (+/- 0.0149)
训练时间: 2026-02-14T22:56:40.915375

各类别置信度:
  类别 1: 0.7504
  类别 2: 0.5445
  类别 3: 0.5902
  类别 4: 0.5398
  类别 5: 0.7136

============================================================
训练结果摘要
============================================================
准确率: 0.7731
交叉验证准确率: 0.7163 (+/- 0.0152)
训练时间: 2026-02-14T23:46:35.518913

各类别置信度:
  类别 1: 0.7547
  类别 2: 0.5529
  类别 3: 0.5917
  类别 4: 0.5427
  类别 5: 0.7228

详细分类报告:
============================================================

类别 1:
  precision: 0.8595
  recall: 0.8739
  f1-score: 0.8667
  support: 357.0000

类别 2:
  precision: 0.6798
  recall: 0.7364
  f1-score: 0.7070
  support: 516.0000

类别 3:
  precision: 0.7888
  recall: 0.7539
  f1-score: 0.7710
  support: 951.0000

类别 4:
  precision: 0.6949
  recall: 0.7132
  f1-score: 0.7039
  support: 530.0000

类别 5:
  precision: 0.8602
  recall: 0.8076
  f1-score: 0.8331
  support: 343.0000

accuracy: 0.7652947719688543

macro avg: {'precision': 0.776633945889751, 'recall': 0.7770229256243208, 'f1-score': 0.7763208948160509, 'support': 2697.0}

weighted avg: {'precision': 0.7679192417730677, 'recall': 0.7652947719688543, 'f1-score': 0.7661143183908127, 'support': 2697.0}

详细分类报告:
============================================================

类别 1:
  precision: 0.8615
  recall: 0.8711
  f1-score: 0.8663
  support: 357.0000

类别 2:
  precision: 0.6958
  recall: 0.7403
  f1-score: 0.7174
  support: 516.0000

类别 3:
  precision: 0.7935
  recall: 0.7676
  f1-score: 0.7803
  support: 951.0000

类别 4:
  precision: 0.7041
  recall: 0.7094
  f1-score: 0.7068
  support: 530.0000


类别 5:
  precision: 0.8589
  recall: 0.8338
  f1-score: 0.8462
  support: 343.0000

accuracy: 0.7730812013348165

macro avg: {'precision': 0.782752675890812, 'recall': 0.7844649560112412, 'f1-score': 0.7833836587373642, 'support': 2697.0}

weighted avg: {'precision': 0.7745503163742733, 'recall': 0.7730812013348165, 'f1-score': 0.7735792218907596, 'support': 2697.0}

Precision（精确率） ：预测为某类的样本中，真正属于该类的比例
Recall（召回率） ：真正属于某类的样本中，被正确预测的比例
F1-Score ：精确率和召回率的调和平均
Support（样本数） ：该类别在测试集中的样本数

### 模型表现分析 ✅ 优势
1. 极端类别表现好 ：类别 1（大跌）和类别 5（大涨）F1-Score > 0.83
2. 横盘识别准确 ：类别 3 F1-Score = 0.77，样本最多
3. 整体准确率 ：76.53% 对 5 类分类是不错的水平 ⚠️ 问题
1. 中间类别较弱 ：类别 2（跌）和类别 4（涨）F1-Score 仅 0.70-0.71
2. 精确率偏低 ：类别 2、4 的精确率 < 70%，误报较多
3. 样本不均衡 ：类别 3 样本数（951）是类别 5（343）的 2.77 倍

# 删除绝对值特征，只保留比例
# feature_1h_creator.py 中移除：
- upper_shadow_1h
- lower_shadow_1h  
- body_height_1h

# 保留比例特征：
+ upper_shadow_ratio_1h
+ lower_shadow_ratio_1h
+ total_shadow_ratio_1h
+ shadow_imbalance_1h
+ body_ratio_1h

# 删除二/多元分类特征
- is_long_upper_shadow_1h
- is_long_lower_shadow_1h
- is_doji_1h
- shadow_type_1h

